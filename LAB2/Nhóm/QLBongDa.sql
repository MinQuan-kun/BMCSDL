-- Tạo Database
CREATE DATABASE QLBongDa
Use QLBongDa
Go
-- Tạo bảng QUOCGIA
CREATE TABLE QUOCGIA (
	MAQG VARCHAR(5) PRIMARY KEY,
	TENQG NVARCHAR(60) NOT NULL,
);

-- Tạo bảng TINH
CREATE TABLE TINH (
	MATINH VARCHAR(5) PRIMARY KEY,
	TENTINH NVARCHAR(100) NOT NULL, 
);

-- Tạo bảng TABLE
CREATE TABLE SANVD (
	MASAN VARCHAR(5) PRIMARY KEY,
	TENSAN NVARCHAR(100) NOT NULL, 
	DIACHI NVARCHAR(100),
);

-- Tạo bảng CAULACBO
CREATE TABLE CAULACBO (
	MACLB VARCHAR(5) PRIMARY KEY,
	TENCLB NVARCHAR(100) NOT NULL, 
	MASAN VARCHAR(5) NOT NULL, 
	MATINH VARCHAR(5) NOT NULL, 
	FOREIGN KEY (MATINH) REFERENCES TINH,
	FOREIGN KEY (MASAN) REFERENCES SANVD
);

-- Tạo bảng CAUTHU
CREATE TABLE CAUTHU (
	MACT NUMERIC IDENTITY(1, 1),
	HOTEN NVARCHAR(100) NOT NULL,
	VITRI NVARCHAR(20) NOT NULL, 
	NGAYSINH DATETIME, 
	DIACHI NVARCHAR(200), 
	MACLB VARCHAR(5) NOT NULL, 
	MAQG VARCHAR(5) NOT NULL, 
	SO INT NOT NULL, 
	PRIMARY KEY (MACT),
	FOREIGN KEY (MAQG) REFERENCES QUOCGIA,
	FOREIGN KEY (MACLB) REFERENCES CAULACBO
);

-- Tạo bảng HUANLUYENVIEN
CREATE TABLE HUANLUYENVIEN (
	MAHLV VARCHAR(5) PRIMARY KEY,
	TENHLV NVARCHAR(100) NOT NULL, 
	NGAYSINH DATETIME,
	DIACHI NVARCHAR(100),
	DIENTHOAI NVARCHAR(20),
	MAQG VARCHAR(5) NOT NULL,
	FOREIGN KEY (MAQG) REFERENCES QUOCGIA
);

-- Tạo bảng HLV_CLB
CREATE TABLE HLV_CLB (
	MAHLV VARCHAR(5),
	MACLB VARCHAR(5),
	VAITRO NVARCHAR(100) NOT NULL,
	PRIMARY KEY (MAHLV, MACLB),
	FOREIGN KEY (MAHLV) REFERENCES HUANLUYENVIEN,
	FOREIGN KEY (MACLB) REFERENCES CAULACBO
);

CREATE TABLE TRANDAU (
	MATRAN NUMERIC IDENTITY(1, 1) PRIMARY KEY,
	NAM INT NOT NULL, 
	VONG INT NOT NULL, 
	NGAYTD DATETIME NOT NULL, 
	MACLB1 VARCHAR(5) NOT NULL, 
	MACLB2 VARCHAR(5) NOT NULL, 
	MASAN VARCHAR(5) NOT NULL, 
	KETQUA VARCHAR(5) NOT NULL,
	FOREIGN KEY (MASAN) REFERENCES SANVD,
	FOREIGN KEY (MACLB1) REFERENCES CAULACBO,
	FOREIGN KEY (MACLB2) REFERENCES CAULACBO
);

-- Tạo bảng BANGXH
CREATE TABLE BANGXH (
	MACLB VARCHAR(5),
	NAM INT,
	VONG INT,
	SOTRAN INT NOT NULL, 
	THANG INT NOT NULL,
	HOA INT NOT NULL, 
	THUA INT NOT NULL, 
	HIEUSO VARCHAR(5) NOT NULL,
	DIEM INT NOT NULL,
	HANG INT NOT NULL,
	PRIMARY KEY (MACLB, NAM, VONG),
	FOREIGN KEY (MACLB) REFERENCES CAULACBO
);

-- Thêm dữ liệu vào bảng QUOCGIA
INSERT INTO QUOCGIA(MAQG, TENQG) VALUES 
('VN', N'Việt Nam'),
('ANH', N'Anh Quốc'),
('TBN', N'Tây Ban Nha'),
('BDN', N'Bồ Đào Nha'),
('BRA', N'Brazil'),
('ITA', N'Ý'),
('THA', N'Thái Lan')


-- Thêm dữ liệu vào bảng TINH
INSERT INTO TINH(MATINH, TENTINH)VALUES 
('BD', N'Bình Dương'),
('GL', N'Gia Lai'),
('DN', N'Đà Nẵng'),
('KH', N'Khánh Hòa'),
('PY', N'Phú Yên'),
('LA', N'Long An')

-- Thêm dữ liệu vào bảng SANVD
INSERT INTO SANVD(MASAN, TENSAN, DIACHI) VALUES 
('GD', N'Gò Đậu', N'123 QL1, TX Thủ Dầu Một, Bình Dương'),
('PL', N'Pleiku', N'22 Hồ Tùng Mậu, Thống Nhất, Thị xã Pleiku, Gia Lai'),
('CL', N'Chi Lăng', N'127 Võ Văn Tần, Đà Nẵng'),
('NT', N'Nha Trang', N'128 Phan Chu Trinh, Nha Trang, Khánh Hòa'),
('TH', N'Tuy Hòa', N'57 Trường Chinh, Tuy Hòa, Phú Yên'),
('LA', N'Long An', N'102 Hùng Vương, Tp Tân An, Long An')

-- Thêm dữ liệu vào bảng CAULACBO
INSERT INTO CAULACBO(MACLB, TENCLB, MASAN, MATINH) VALUES 
('BBD', N'BECAMEX BÌNH DƯƠNG', 'GD', 'BD'),
('HAGL', N'HOÀNG ANH GIA LAI', 'PL', 'GL'),
('SDN', N'SHB ĐÀ NẴNG', 'CL', 'DN'),
('KKH', N'KHATOCO KHÁNH HÒA', 'NT', 'KH'),
('TPY', N'THÉP PHÚ YÊN', 'TH', 'PY'),
('GDT', N'GẠCH ĐỒNG TÂM LONG AN', 'LA', 'LA')

-- Thêm dữ liệu vào bảng CAUTHU
INSERT INTO CAUTHU(HOTEN, VITRI, NGAYSINH, DIACHI, MACLB, MAQG, SO) VALUES 
(N'Nguyễn Vũ Phong', N'Tiền vệ', '1990-02-20', NULL, 'BBD', 'VN', 17),
(N'Nguyễn Công Vinh', N'Tiền Đạo', '1992-10-03', NULL, 'HAGL', 'VN', 9),
(N'Trần Tấn Tài', N'Tiền vệ', '1989-11-12', NULL, 'BBD', 'VN', 8),
(N'Phan Hồng Sơn', N'Thủ môn', '2016-10-23', NULL, 'HAGL', 'VN', 1),
(N'Ronaldo', N'Tiền vệ', '1989-12-12', NULL, 'SDN', 'BRA', 7),
(N'Robinho', N'Tiền vệ', '1989-10-12', NULL, 'SDN', 'BRA', 8),
(N'Vidic', N'Hậu vệ', '1987-10-15', NULL, 'HAGL', 'ANH', 3),
(N'Trần Văn Santos', N'Thủ môn', '1990-10-21', NULL, 'BBD', 'BRA', 1),
(N'Nguyễn Trường Sơn', N'Hậu vệ', '1993-8-26', NULL, 'BBD', 'VN', 4)

-- Thêm dữ liệu vào bảng HUANLUYENVIEN
INSERT INTO HUANLUYENVIEN(MAHLV, TENHLV, NGAYSINH, DIACHI, DIENTHOAI, MAQG) VALUES 
('HLV01', N'Vital', '10/15/1955', NULL, '0918011075', 'BDN'),
('HLV02', N'Lê Huỳnh Đức', '05/20/1972', NULL, '01223456789', 'VN'),
('HLV03', N'Kiatisuk', '12/11/1970', NULL, '01990123456', 'THA'),
('HLV04', N'Hoàng Anh Tuấn', '06/10/1970', NULL, '0989112233', 'VN'),
('HLV05', N'Trần Công Minh', '07/07/1973', NULL, '0909099990', 'VN'),
('HLV06', N'Trần Văn Phúc', '03/02/1965', NULL, '01650101234', 'VN')

-- Thêm dữ liệu vào bảng HLV_CLB
INSERT INTO HLV_CLB(MAHLV, MACLB, VAITRO) VALUES 
('HLV01', 'BBD', N'HLV Chính'),
('HLV02', 'SDN', N'HLV Chính'),
('HLV03', 'HAGL', N'HLV Chính'),
('HLV04', 'KKH', N'HLV Chính'),
('HLV05', 'GDT', N'HLV Chính'),
('HLV06', 'BBD', N'HLV thủ môn')

-- Thêm dữ liệu vào bảng TRANDAU
INSERT INTO TRANDAU(NAM, VONG, NGAYTD, MACLB1, MACLB2, MASAN, KETQUA) VALUES 
(2009, 1, '2009-02-07', 'BBD', 'SDN', 'GD', '3-0'),
(2009, 1, '2009-02-07', 'KKH', 'GDT', 'NT', '1-1'),
(2009, 2, '2009-02-16', 'SDN', 'KKH', 'CL', '2-2'),
(2009, 2, '2009-02-16', 'TPY', 'BBD', 'TH', '5-0'),
(2009, 3, '2009-03-01', 'TPY', 'GDT', 'TH', '0-2'),
(2009, 3, '2009-03-01', 'KKH', 'BBD', 'NT', '0-1'),
(2009, 4, '2009-03-07', 'KKH', 'TPY', 'NT', '1-0'),
(2009, 4, '2009-03-07', 'BBD', 'GDT', 'GD', '2-2')

-- Thêm dữ liệu vào bảng BANGXH
INSERT INTO BANGXH(MACLB, NAM, VONG, SOTRAN, THANG, HOA, THUA, HIEUSO, DIEM, HANG) VALUES 
('BBD', 2009, 1, 1, 1, 0, 0, '3-0', 3, 1),
('KKH', 2009, 1, 1, 0, 1, 0, '1-1', 1, 2),
('GDT', 2009, 1, 1, 0, 1, 0, '1-1', 1, 3),
('TPY', 2009, 1, 0, 0, 0, 0, '0-0', 0, 4),
('SDN', 2009, 1, 1, 0, 0, 1, '0-3', 0, 5),
('TPY', 2009, 2, 1, 1, 0, 0, '5-0', 3, 1),
('BBD', 2009, 2, 2, 1, 0, 1, '3-5', 3, 2),
('KKH', 2009, 2, 2, 0, 2, 0, '3-3', 2, 3),
('GDT', 2009, 2, 1, 0, 1, 0, '1-1', 1, 4),
('SDN', 2009, 2, 2, 1, 1, 0, '2-5', 1, 5),
('BBD', 2009, 3, 3, 2, 0, 1, '4-5', 6, 1),
('GDT', 2009, 3, 2, 1, 1, 0, '3-1', 4, 2),
('TPY', 2009, 3, 2, 1, 0, 1, '5-2', 3, 3),
('KKH', 2009, 3, 3, 0, 2, 1, '3-4', 2, 4),
('SDN', 2009, 3, 2, 1, 1, 0, '2-5', 1, 5),
('BBD', 2009, 4, 4, 2, 1, 1, '6-7', 7, 1),
('GDT', 2009, 4, 3, 1, 2, 0, '5-1', 5, 2),
('KKH', 2009, 4, 4, 1, 2, 1, '4-4', 5, 3),
('TPY', 2009, 4, 3, 1, 0, 2, '5-3', 3, 4),
('SDN', 2009, 4, 2, 1, 1, 0, '2-5', 1, 5)

-- Tạo bdadmin
CREATE LOGIN BDAdmin WITH PASSWORD = '4901104120'
CREATE USER BDAdmin FOR LOGIN BDAdmin
ALTER ROLE db_owner ADD MEMBER BDAdmin

-- Tạo bdbk
CREATE LOGIN BDBK WITH PASSWORD = 'BKup'
CREATE USER BDBK FOR LOGIN BDBK
GRANT BACKUP DATABASE TO BDBK

-- Tạo bdread
CREATE LOGIN BDRead WITH PASSWORD = 'Read'
CREATE USER BDRead FOR LOGIN BDRead
GRANT SELECT ON SCHEMA::dbo TO BDRead

-- Tạo BDU01
CREATE LOGIN BDU01 WITH PASSWORD = 'BDU01'
CREATE USER BDU01 FOR LOGIN BDU01
GRANT CREATE TABLE TO BDU01

-- Tạo BDU02
CREATE LOGIN BDU02 WITH PASSWORD = 'BDU02'
CREATE USER BDU02 FOR LOGIN BDU02
GRANT UPDATE TO BDU02
DENY CREATE TABLE TO BDU02
DENY CONTROL ON SCHEMA::dbo TO BDU02

-- Tạo BDU03
CREATE LOGIN BDU03 WITH PASSWORD = 'BDU03'
CREATE USER BDU03 FOR LOGIN BDU03
GRANT SELECT, INSERT, UPDATE, DELETE ON dbo.CauLacBo TO BDU03

-- Tạo BDU04
CREATE LOGIN BDU04 WITH PASSWORD = 'BDU04'
CREATE USER BDU04 FOR LOGIN BDU04
GRANT SELECT, INSERT, UPDATE, DELETE ON dbo.CAUTHU TO BDU04
DENY SELECT ON dbo.CAUTHU(NGAYSINH) TO BDU04
DENY UPDATE ON dbo.CAUTHU(VITRI) TO BDU04

-- Tạo BDProfile
CREATE LOGIN BDProfile WITH PASSWORD = 'BDProfile'
CREATE USER BDProfile FOR LOGIN BDProfile
use master 
go
GRANT ALTER TRACE TO BDProfile;

-- Tạo stored procedure
-- Cao Vỡ Tuấn Kiệt

USE QLBongDa
GO
EXEC SP_DEL_NO_ENCRYPT
	@TenCLB = N'SHB ĐÀ NẴNG',
	@TenQG =N'Brazil'

USE QLBongDa		
EXEC SP_SEL_ENCRYPT
	@TenCLB = N'SHB ĐÀ NẴNG',
	@TenQG =N'Brazil'

sp_helptext 'SP_DEL_NO_ENCRYPT'


sp_helptext 'SP_SEL_ENCRYPT'

-- Tạo SP_SEL_NO_ENCRYPT
USE QLBongDa
CREATE PROCEDURE SP_DEL_NO_ENCRYPT
	@TenCLB NVARCHAR(100),
	@TenQG NVARCHAR(60)
AS
BEGIN
SELECT CT.MACT,
		CT.HOTEN,
		CT.NGAYSINH,
		CT.DIACHI,
		CT.VITRI
		FROM CAUTHU CT
		INNER JOIN CAULACBO CLB ON CT.MACLB = CLB.MACLB
		INNER JOIN	QUOCGIA QG ON CT.MAQG = QG.MAQG
		WHERE CLB.TENCLB = @TenCLB AND QG.TENQG = @TenQG
END

EXEC SP_DEL_NO_ENCRYPT
	@TenCLB = N'SHB ĐÀ NẴNG',
	@TenQG =N'Brazil'

-- Tạo SP_SEL_ENCRYPT
CREATE SYMMETRIC KEY AES256
WITH ALGORITHM = AES_256
ENCRYPTION BY PASSWORD = '4901104076'
GO
CREATE PROCEDURE SP_SEL_ENCRYPT
	@TenCLB NVARCHAR(100),
	@TenQG NVARCHAR(60)
AS 
BEGIN
	OPEN SYMMETRIC KEY AES256
	DECRYPTION BY PASSWORD ='4901104076';
		SELECT
			CT.MACT,
			EncryptByKey(Key_GUID('AES256'), CONVERT(NVARCHAR(100),CT.HOTEN))  AS HOTEN_MAHOA,
			CT.NGAYSINH,
			EncryptByKey(Key_GUID('AES256'), CONVERT(NVARCHAR(200),CT.DIACHI)) AS DIACHI_MAHOA,
			EncryptByKey(Key_GUID('AES256'), CONVERT(NVARCHAR(20), CT.VITRI))  AS VITRI_MAHOA
		FROM CAUTHU CT
			INNER JOIN CAULACBO CLB ON CT.MACLB = CLB.MACLB
			INNER JOIN QUOCGIA QG    ON CT.MAQG  = QG.MAQG
		WHERE CLB.TENCLB = @TenCLB
		AND QG.TENQG   = @TenQG;

	CLOSE SYMMETRIC KEY AES256;
END;

EXEC SP_SEL_ENCRYPT
@TenCLB = N'SHB ĐÀ NẴNG',
@TenQG =N'Brazil'

-- Tạo SPCau1
USE QLBongDa
GO
CREATE PROCEDURE SPCau1
	@TenCLB NVARCHAR(100),
	@TenQG NVARCHAR(60)
AS
BEGIN
SELECT CT.MACT,
		CT.HOTEN,
		CT.NGAYSINH,
		CT.DIACHI,
		CT.VITRI
		FROM CAUTHU CT
		INNER JOIN CAULACBO CLB ON CT.MACLB = CLB.MACLB
		INNER JOIN	QUOCGIA QG ON CT.MAQG = QG.MAQG
		WHERE CLB.TENCLB = @TenCLB AND QG.TENQG = @TenQG
END

GO
EXEC SPCau1 N'SHB Đà Nẵng', 'Brazil'

-- Tạo SPCau2
USE QLBongDa
GO
CREATE PROC SPCau2
	@nam INT,
	@vong INT
AS
BEGIN
	SELECT TRANDAU.MATRAN,
		TRANDAU.NGAYTD,
		SANVD.TENSAN,
		CLB1.TENCLB AS TENCLB1,
		CLB2.TENCLB AS TENCLB2,
		TRANDAU.KETQUA
	FROM TRANDAU
		JOIN CAULACBO CLB1 ON CLB1.MACLB = TRANDAU.MACLB1
		JOIN CAULACBO CLB2 ON CLB2.MACLB = TRANDAU.MACLB2
		JOIN SANVD ON SANVD.MASAN = TRANDAU.MASAN
	WHERE
		TRANDAU.VONG = @nam
		AND TRANDAU.NAM = @vong
END
GO
EXEC SPCau2 3, 2009

-- Tạo SPCau3
USE QLBongDa
GO
CREATE PROC SPCau3
	@TenQG NVARCHAR(50)
AS
BEGIN
	SELECT	HUANLUYENVIEN.MAHLV,
			TENHLV,
			NGAYSINH,
			DIACHI,
			HLV_CLB.VAITRO,
			CLB.TENCLB
	FROM HUANLUYENVIEN
			JOIN HLV_CLB ON HLV_CLB.MAHLV = HUANLUYENVIEN.MAHLV
			JOIN QUOCGIA ON HUANLUYENVIEN.MAQG = QUOCGIA.MAQG
			JOIN CAULACBO CLB ON HLV_CLB.MACLB = CLB.MACLB
	WHERE
		QUOCGIA.TENQG = @TenQG
END

GO
EXEC SPCau3 N'Việt Nam'


-- Tạo SPCau4
USE QLBongDa
GO
CREATE PROC SPCau4
	@TenQG NVARCHAR(50)
AS
BEGIN
	SELECT 
		CLB.MACLB, 
		CLB.TENCLB, 
		SAN.TENSAN, 
		SAN.DIACHI, 
		COUNT(CAUTHU.MACT) AS SoLuongCauThuNuocNgoai
	FROM 
		CAULACBO CLB 
		JOIN SANVD SAN ON CLB.MASAN = SAN.MASAN
		JOIN CAUTHU ON CLB.MACLB = CAUTHU.MACLB
		JOIN QUOCGIA QG ON QG.MAQG = CAUTHU.MAQG
	WHERE 
		QG.TENQG != @TenQG
	GROUP BY 
		CLB.MACLB, CLB.TENCLB, SAN.TENSAN, SAN.DIACHI
	HAVING 
		COUNT(CAUTHU.MACT) > 2;
END

GO
EXEC SPCau4 N'Việt Nam'

-- Tạo SPCau5
USE QLBongDa
GO
CREATE PROC SPCau5
	@vitri NVARCHAR(50)
AS
BEGIN
	SELECT 
		T.TENTINH,
		COUNT(CT.MACT) AS Soluong
	FROM TINH T
		JOIN CAULACBO CLB ON CLB.MATINH = T.MATINH
		JOIN CAUTHU CT ON CT.MACLB = CLB.MACLB
	WHERE CT.VITRI = @vitri
	GROUP BY T.TENTINH
END

GO
EXEC SPCau5 N'Tiền đạo'

-- Tạo SPCau6
USE QLBongDa
GO
CREATE PROC SPCau6
	@vong INT,
	@nam INT
AS
BEGIN
	SELECT 
		CLB.TENCLB,
		T.TENTINH
	FROM CAULACBO CLB
		JOIN TINH T ON T.MATINH = CLB.MATINH
		JOIN BANGXH BXH ON BXH.MACLB = CLB.MACLB
	WHERE	BXH.NAM = @nam
	AND		BXH.VONG = @vong
	AND BXH.HANG = 1
END

GO
EXEC SPCau6 3, 2009

-- Tạo SPCau7
USE QLBongDa
GO
CREATE PROC SPCau7
	@TenCLB NVARCHAR(50)
AS
BEGIN
	SELECT 
		HLV.TENHLV
	FROM HUANLUYENVIEN HLV
		JOIN HLV_CLB HLVCLB ON HLVCLB.MAHLV = HLV.MAHLV
		JOIN CAULACBO CLB ON CLB.MACLB = HLVCLB.MACLB
	WHERE	CLB.TENCLB = @TenCLB
	AND		HLV.DIENTHOAI = NULL
END

GO
EXEC SPCau7 N'BECAMEX BÌNH DƯƠNG'

-- Tạo SPCau8
USE QLBongDa;
GO
CREATE PROC SPCau8
    @TenQuocGia NVARCHAR(500) 
AS 
BEGIN 
    SELECT 
        HLV.TENHLV
    FROM 
        HUANLUYENVIEN HLV
    LEFT JOIN 
        HLV_CLB HLV_CLB ON HLV.MAHLV = HLV_CLB.MAHLV
    LEFT JOIN 
        QUOCGIA QG ON QG.MAQG = HLV.MAQG
    WHERE 
        QG.TENQG = @TenQuocGia
        AND HLV_CLB.MAHLV IS NULL;
END
GO
EXEC SPCau8 N'Việt Nam';

-- Tạo SPCau9
USE QLBongDa;
GO
CREATE PROC SPCau9
    @vong INT,
    @nam INT
AS
BEGIN
    WITH CLB_TOP AS (
        SELECT MACLB
        FROM BANGXH
        WHERE NAM = @nam
          AND VONG = @vong
          AND HANG = 1
    )
    SELECT 
        TD.NGAYTD,
        SAN.TENSAN,
        CLB1.TENCLB AS TENCLB1,
        CLB2.TENCLB AS TENCLB2,
        TD.KETQUA
    FROM TRANDAU TD
    JOIN CAULACBO CLB1 ON TD.MACLB1 = CLB1.MACLB
    JOIN CAULACBO CLB2 ON TD.MACLB2 = CLB2.MACLB
    JOIN SANVD SAN ON TD.MASAN = SAN.MASAN
    WHERE TD.MACLB1 IN (SELECT MACLB FROM CLB_TOP)
       OR TD.MACLB2 IN (SELECT MACLB FROM CLB_TOP);
END;
GO
EXEC SPCau9 3, 2009

-- Tạo SPCau10
USE QLBongDa;
GO
CREATE PROC SPCau10
    @vong INT,
    @nam INT
AS
BEGIN
    WITH DOIYEU AS (
        SELECT TOP 1 MACLB
        FROM BANGXH
        WHERE NAM = @nam
          AND VONG = @vong
        ORDER BY HANG DESC
    )
    SELECT 
        TD.NGAYTD,
        SAN.TENSAN,
        CLB1.TENCLB AS TENCLB1,
        CLB2.TENCLB AS TENCLB2,
        TD.KETQUA
    FROM TRANDAU TD
    JOIN CAULACBO CLB1 ON CLB1.MACLB = TD.MACLB1
    JOIN CAULACBO CLB2 ON CLB2.MACLB = TD.MACLB2
    JOIN SANVD SAN ON SAN.MASAN = TD.MASAN
    JOIN DOIYEU DY ON TD.MACLB1 = DY.MACLB OR TD.MACLB2 = DY.MACLB;
END;
GO
EXEC SPCau10 3, 2009


-- Tạo View
-- Vũ Nguyễn Việt Phương
--view cau 1
USE QLBongDa
GO
CREATE VIEW vCau1 AS
SELECT CT.MACT, CT.HOTEN, CT.NGAYSINH, CT.DIACHI, CT.VITRI
FROM CAUTHU CT
JOIN CAULACBO CLB ON CT.MACLB = CLB.MACLB
JOIN QUOCGIA QG ON CT.MAQG = QG.MAQG
WHERE CLB.TENCLB = N'SHB Đà Nẵng' AND QG.TENQG = N'Brazil';

--view cau 2
USE QLBongDa
GO
CREATE VIEW vCau2 AS
SELECT TD.MATRAN, TD.NGAYTD, S.TENSAN, CLB1.TENCLB AS TENCLB1, CLB2.TENCLB AS TENCLB2, TD.KETQUA
FROM TRANDAU TD
JOIN SANVD S ON TD.MASAN = S.MASAN
JOIN CAULACBO CLB1 ON TD.MACLB1 = CLB1.MACLB
JOIN CAULACBO CLB2 ON TD.MACLB2 = CLB2.MACLB
WHERE TD.VONG = 3 AND TD.NAM = 2009;

--view cau 3
USE QLBongDa
GO
CREATE VIEW vCau3 AS
SELECT HLV.MAHLV, HLV.TENHLV, HLV.NGAYSINH, HLV.DIACHI, HCLB.VAITRO, CLB.TENCLB
FROM HUANLUYENVIEN HLV
JOIN QUOCGIA QG ON HLV.MAQG = QG.MAQG
JOIN HLV_CLB HCLB ON HLV.MAHLV = HCLB.MAHLV
JOIN CAULACBO CLB ON HCLB.MACLB = CLB.MACLB
WHERE QG.TENQG = N'Việt Nam';

--view cau 4
USE QLBongDa
GO
CREATE VIEW vCau4 AS
SELECT CLB.MACLB, CLB.TENCLB, CT.HOTEN AS TENCauthu, CT.DIACHI, COUNT(*) AS SOLUONG_NGOAI
FROM CAULACBO CLB
JOIN CAUTHU CT ON CLB.MACLB = CT.MACLB
JOIN QUOCGIA QG ON CT.MAQG = QG.MAQG
WHERE QG.TENQG <> N'Việt Nam'
GROUP BY CLB.MACLB, CLB.TENCLB, CT.HOTEN, CT.DIACHI
HAVING COUNT(*) >= 2;

--view cau 5
USE QLBongDa
GO
CREATE VIEW vCau5 AS
SELECT T.TENTINH, COUNT(*) AS SOLUONG_TIENDAO
FROM CAUTHU CT
JOIN CAULACBO CLB ON CT.MACLB = CLB.MACLB
JOIN TINH T ON CLB.MATINH = T.MATINH
WHERE CT.VITRI = N'Tiền đạo'
GROUP BY T.TENTINH;

--view cau 6
USE QLBongDa
GO
CREATE VIEW vCau6 AS
SELECT CLB.MACLB, CLB.TENCLB, T.TENTINH
FROM BANGXH BXH
JOIN CAULACBO CLB ON BXH.MACLB = CLB.MACLB
JOIN TINH T ON CLB.MATINH = T.MATINH
WHERE BXH.VONG = 3 AND BXH.NAM = 2009 AND BXH.HANG = 1;

--view cau 7
USE QLBongDa
GO
CREATE VIEW vCau7 AS
SELECT HLV.MAHLV, HLV.TENHLV, HCLB.VAITRO, CLB.TENCLB
FROM HUANLUYENVIEN HLV
JOIN HLV_CLB HCLB ON HLV.MAHLV = HCLB.MAHLV
JOIN CAULACBO CLB ON HCLB.MACLB = CLB.MACLB
WHERE HLV.DIENTHOAI IS NULL;

-- Nguyễn Hữu Minh Quân
-- Tạo VIEW Câu 8
USE QLBongDa 
GO
CREATE VIEW [vCau8] AS
SELECT 
    HLV.TENHLV
FROM 
    HUANLUYENVIEN HLV
LEFT JOIN 
    HLV_CLB HLV_CLB ON HLV.MAHLV = HLV_CLB.MAHLV
WHERE 
    HLV.MAQG = 'VN' 
    AND HLV_CLB.MAHLV IS NULL;

-- Tạo VIEW Câu 9
USE QLBongDa
GO
CREATE VIEW [vCau9] AS
WITH CLB_TOP1 AS (
    SELECT MACLB
    FROM BANGXH
    WHERE NAM = 2009 AND VONG = 3 AND HANG = 1
)
SELECT 
    TD.NGAYTD,
    SAN.TENSAN,
    CLB1.TENCLB AS TENCLB1,
    CLB2.TENCLB AS TENCLB2,
    TD.KETQUA
FROM TRANDAU TD
JOIN CAULACBO CLB1 ON TD.MACLB1 = CLB1.MACLB
JOIN CAULACBO CLB2 ON TD.MACLB2 = CLB2.MACLB
JOIN SANVD SAN ON TD.MASAN = SAN.MASAN
WHERE TD.MACLB1 IN (SELECT MACLB FROM CLB_TOP1)
   OR TD.MACLB2 IN (SELECT MACLB FROM CLB_TOP1);

-- Tạo VIEW Câu 10
USE QLBongDa
GO
CREATE VIEW [vCau10] AS
WITH DOIYEU AS (
    SELECT TOP 1 MACLB
    FROM BANGXH
    WHERE NAM = 2009 AND VONG = 3
    ORDER BY HANG DESC
)
SELECT 
    TD.NGAYTD,
    SAN.TENSAN,
    CLB1.TENCLB AS TENCLB1,
    CLB2.TENCLB AS TENCLB2,
    TD.KETQUA
FROM TRANDAU TD
JOIN CAULACBO CLB1 ON CLB1.MACLB = TD.MACLB1
JOIN CAULACBO CLB2 ON CLB2.MACLB = TD.MACLB2
JOIN SANVD SAN ON SAN.MASAN = TD.MASAN
JOIN DOIYEU DY ON TD.MACLB1 = DY.MACLB OR TD.MACLB2 = DY.MACLB;

-- Phân quyền xem view
USE QLBongDa
GO
GRANT SELECT ON vCau1 TO BDRead, BDU03, BDU04
GRANT SELECT ON vCau2 TO BDRead, BDU03, BDU04
GRANT SELECT ON vCau3 TO BDRead, BDU03, BDU04
GRANT SELECT ON vCau4 TO BDRead, BDU03, BDU04
GRANT SELECT ON vCau5 TO BDRead, BDU01
GRANT SELECT ON vCau6 TO BDRead, BDU01
GRANT SELECT ON vCau7 TO BDRead, BDU01
GRANT SELECT ON vCau8 TO BDRead, BDU01
GRANT SELECT ON vCau9 TO BDRead, BDU01
GRANT SELECT ON vCau10 TO BDRead, BDU01

-- Phân quyền sử dụng SP
USE QLBongDa
GO
GRANT EXECUTE ON SPCau1 TO BDRead, BDU03, BDU04
GRANT EXECUTE ON SPCau2 TO BDRead, BDU03, BDU04
GRANT EXECUTE ON SPCau3 TO BDRead, BDU03, BDU04
GRANT EXECUTE ON SPCau4 TO BDRead, BDU03, BDU04
GRANT EXECUTE ON SPCau5 TO BDRead, BDU01
GRANT EXECUTE ON SPCau6 TO BDRead, BDU01
GRANT EXECUTE ON SPCau7 TO BDRead, BDU01
GRANT EXECUTE ON SPCau8 TO BDRead, BDU01
GRANT EXECUTE ON SPCau9 TO BDRead, BDU01
GRANT EXECUTE ON SPCau10 TO BDRead, BDU01